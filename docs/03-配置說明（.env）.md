# 03-配置說明（.env）

> 原則：先用預設跑通，再按吞吐與告警品質微調。

## 連線與資料來源

- `FUTU_HOST`：OpenD 位址（同機常用 `127.0.0.1`）
- `FUTU_PORT`：OpenD port，預設 `11111`
- `FUTU_SYMBOLS`：逗號分隔，如 `HK.00700,HK.00981`
- `FUTU_POLL_ENABLED`：`1` 開啟 poll 備援
- `FUTU_POLL_TRADING_ONLY`：`1` 時僅在交易時段執行常規 poll（建議開啟）
- `FUTU_POLL_PREOPEN_ENABLED`：`1` 時開盤前（09:00-09:30 HKT）也執行常規 poll
- `FUTU_POLL_OFFHOURS_PROBE_INTERVAL_SEC`：非交易時段 probe 間隔秒數，`0` 代表停用（預設）
- `FUTU_POLL_OFFHOURS_PROBE_NUM`：probe 單次每 symbol 讀取筆數
- `FUTU_HOLIDAYS`：手動指定休市日（`YYYYMMDD` 逗號分隔）
- `FUTU_HOLIDAY_FILE`：休市日檔案路徑（每行一個 `YYYYMMDD`）

## 採集佇列與批次

- `BATCH_SIZE`：每批寫入筆數，預設 `500`
- `MAX_WAIT_MS`：最長等待 flush 時間，預設 `1000`
- `MAX_QUEUE_SIZE`：佇列上限，預設 `20000`

## SQLite（建議先維持預設）

- `SQLITE_JOURNAL_MODE=WAL`
- `SQLITE_SYNCHRONOUS=NORMAL`
- `SQLITE_BUSY_TIMEOUT_MS=5000`
- `SQLITE_WAL_AUTOCHECKPOINT=1000`

備註：

- 服務啟動不再預先建立當日 DB，僅在首筆 tick 寫入時建立（避免非交易日空 DB）。
- WAL 模式下 `.db-wal` 在程序存活期間存在是正常行為，不代表持續有新成交寫入。

## Watchdog

- `WATCHDOG_STALL_SEC`：多久視為寫入停滯，預設 `180`
- `WATCHDOG_QUEUE_THRESHOLD_ROWS`：觸發門檻，預設 `100`
- `WATCHDOG_RECOVERY_MAX_FAILURES`：恢復失敗容忍次數

## Telegram（產品化）

- `TG_ENABLED=1`
- `TG_TOKEN` / `TG_CHAT_ID`
- `TG_THREAD_HEALTH_ID` / `TG_THREAD_OPS_ID`（有 topics 才設）
- `ALERT_COOLDOWN_SEC`：同 fingerprint 告警冷卻
- `TG_INTERACTIVE_ENABLED=1`：啟用 `getUpdates` 互動按鈕
- `TG_ADMIN_USER_IDS=1001,1002`：限制可操作按鈕的 Telegram user id（可選）
- `TG_ACTION_CONTEXT_TTL_SEC`：按鈕上下文保存秒數（預設 43200）
- `TG_ACTION_LOG_MAX_LINES`：日誌摘要最多幾行（預設 20）
- `TG_ACTION_TIMEOUT_SEC`：按鈕命令逾時秒數（預設 3.0）

## 盤前 / 盤中 / 盤後建議

- 盤前（pre-open）：健康訊息可低頻（`30m`）
- 盤中（open）：健康訊息中頻（`15m`）
- 盤後（after-hours）：健康訊息低頻或一次

## 快速檢查

```bash
scripts/hk-tickctl logs --ops --since "20 minutes ago"
scripts/hk-tickctl db stats
scripts/hk-tickctl db symbols --minutes 10
```
