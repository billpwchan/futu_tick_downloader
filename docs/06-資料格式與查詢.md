# 06-資料格式與查詢

## SQLite schema（核心）

```sql
CREATE TABLE ticks (
  market TEXT NOT NULL,
  symbol TEXT NOT NULL,
  ts_ms INTEGER NOT NULL,
  price REAL,
  volume INTEGER,
  turnover REAL,
  direction TEXT,
  seq INTEGER,
  tick_type TEXT,
  push_type TEXT,
  provider TEXT,
  trading_day TEXT NOT NULL,
  recv_ts_ms INTEGER NOT NULL,
  inserted_at_ms INTEGER NOT NULL
);
```

```sql
CREATE TABLE gaps (
  trading_day TEXT NOT NULL,
  symbol TEXT NOT NULL,
  gap_start_ts_ms INTEGER NOT NULL,
  gap_end_ts_ms INTEGER NOT NULL,
  gap_sec REAL NOT NULL,
  detected_at_ms INTEGER NOT NULL,
  reason TEXT NOT NULL,
  meta_json TEXT NOT NULL,
  PRIMARY KEY (symbol, gap_start_ts_ms, gap_end_ts_ms)
);
```

## 常用 SQL

### 1) 按 symbol 查最近 20 筆

```sql
SELECT symbol, datetime(ts_ms/1000,'unixepoch') AS ts_utc, price, volume, turnover, seq
FROM ticks
WHERE symbol='HK.00700'
ORDER BY ts_ms DESC
LIMIT 20;
```

### 2) 按時間區間查筆數

```sql
SELECT COUNT(*) AS rows
FROM ticks
WHERE ts_ms BETWEEN 1707797400000 AND 1707801000000;
```

### 3) 查 drift（資料新鮮度）

```sql
SELECT ROUND(strftime('%s','now') - MAX(ts_ms)/1000.0, 3) AS drift_sec
FROM ticks;
```

### 4) 查今日增量（每個 symbol）

```sql
SELECT symbol, COUNT(*) AS rows, datetime(MAX(ts_ms)/1000,'unixepoch') AS latest_ts_utc
FROM ticks
GROUP BY symbol
ORDER BY symbol;
```

### 5) 查 DB 大小（page）

```sql
SELECT page_count * page_size AS approx_bytes
FROM pragma_page_count(), pragma_page_size();
```

### 6) 查某日 gap 摘要

```sql
SELECT symbol, COUNT(*) AS gaps, SUM(gap_sec) AS gap_total_sec, MAX(gap_sec) AS gap_max_sec
FROM gaps
WHERE trading_day='20260216'
GROUP BY symbol
ORDER BY gaps DESC;
```

## CLI 快速查詢

```bash
scripts/hk-tickctl db stats
scripts/hk-tickctl db symbols --minutes 15
scripts/hk-tickctl validate --data-root /data/sqlite/HK --day 20260216 --regen-report 1
```
