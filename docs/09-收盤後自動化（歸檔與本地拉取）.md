# 09-收盤後自動化（歸檔與本地拉取）

目標：

1. 服務器每日 16:30（UTC+8）自動做歸檔（內含 SQLite 一致性 snapshot）。
2. 本地每日 17:10（UTC+8）自動拉取 `.db.zst`，校驗後轉為 Futu zip。
3. 保留手動 `.command` 一鍵補跑。

---

## A. 服務器端：systemd timer（16:30 UTC+8）

### 1) 安裝 timer/service

```bash
cd /opt/futu_tick_downloader
sudo bash deploy/scripts/install_eod_archive.sh
```

### 2) 編輯環境檔

```bash
sudo cp /opt/futu_tick_downloader/deploy/env/hk-tick-eod-archive.env.example /etc/hk-tick-eod-archive.env
sudo vi /etc/hk-tick-eod-archive.env
```

建議設定：

```dotenv
REPO_ROOT=/opt/futu_tick_downloader
DATA_ROOT=/data/sqlite/HK
ARCHIVE_DIR=/data/sqlite/HK/_archive
RAW_KEEP_DAYS=3
```

> `RAW_KEEP_DAYS=3` 代表歸檔成功後，原始 `.db/.db-wal/.db-shm` 只保留最近 3 天。

### 3) 啟用與檢查

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now hk-tick-eod-archive.timer
sudo systemctl status hk-tick-eod-archive.timer --no-pager
sudo systemctl list-timers --all | grep hk-tick-eod-archive
```

### 4) 手動測試（可選）

```bash
sudo systemctl start hk-tick-eod-archive.service
sudo journalctl -u hk-tick-eod-archive.service --since "30 minutes ago" --no-pager
```

---

## B. 本地端：自動拉取 + 轉 zip（17:10 UTC+8）

### 1) 建立本地設定檔

```bash
cp /Users/billpwchan/Documents/futu_tick_downloader/deploy/env/hk_tick_pull.env.example ~/.hk_tick_pull.env
vi ~/.hk_tick_pull.env
```

至少要改：

```dotenv
SSH_HOST=ubuntu@<server-ip>
REMOTE_ARCHIVE_DIR=/data/sqlite/HK/_archive
LOCAL_EXPORT_ROOT=$HOME/hk_tick_exports
REPO_ROOT=/Users/billpwchan/Documents/futu_tick_downloader
KEEP_LOCAL_DB=1
PULL_WAIT_MINUTES=90
PULL_RETRY_SEC=300
SSH_PORT=22
```

### 2) 先手動跑一次確認

```bash
/Users/billpwchan/Documents/futu_tick_downloader/scripts/local_pull_convert.sh --day $(TZ=Asia/Hong_Kong date +%Y%m%d)
```

### 3) 安裝 launchd 定時

```bash
cp /Users/billpwchan/Documents/futu_tick_downloader/deploy/macos/com.billpwchan.hk-tick-pull.plist ~/Library/LaunchAgents/
launchctl unload ~/Library/LaunchAgents/com.billpwchan.hk-tick-pull.plist 2>/dev/null || true
launchctl load ~/Library/LaunchAgents/com.billpwchan.hk-tick-pull.plist
launchctl list | grep com.billpwchan.hk-tick-pull
```

日誌位置：

- `~/Library/Logs/hk-tick-pull.log`
- `~/Library/Logs/hk-tick-pull.err.log`

---

## C. 手動補跑（.command）

雙擊：

`/Users/billpwchan/Documents/futu_tick_downloader/run_snapshot_to_futu.command`

或命令列：

```bash
open /Users/billpwchan/Documents/futu_tick_downloader/run_snapshot_to_futu.command
```

可指定日期（例如 20260220）：

```bash
/Users/billpwchan/Documents/futu_tick_downloader/run_snapshot_to_futu.command 20260220
```

---

## D. 產物路徑

- 服務器歸檔：
  - `/data/sqlite/HK/_archive/YYYYMMDD.db.zst`
  - `/data/sqlite/HK/_archive/YYYYMMDD.db.zst.sha256`
  - `/data/sqlite/HK/_archive/manifest/YYYYMMDD.json`
- 本地轉換：
  - `~/hk_tick_exports/YYYYMMDD/YYYYMMDD.futu_csv.zip`
  - `~/hk_tick_exports/YYYYMMDD/YYYYMMDD.done`

---

## E. 常見問題

- `SKIP reason=db_not_found`：當天可能是假日或尚未產生 DB，屬正常。
- 本地 timeout：表示歸檔檔案尚未就緒或 SSH 不通，請檢查 `~/.hk_tick_pull.env` 與 SSH key。
- checksum fail：下載檔案不完整或損壞，重新執行 `local_pull_convert.sh --force 1`。
